#include <Wire.h>
#include "MAX30100_PulseOximeter.h"
#include <WiFi.h>
#include <PubSubClient.h>

// ================== Cáº¥u hÃ¬nh I2C ==================
#define SDA_PIN 21
#define SCL_PIN 22

// ================== WiFi ==================
const char* ssid     = "Mo";              // ğŸ‘‰ WiFi cá»§a báº¡n
const char* password = "12345678910";    // ğŸ‘‰ Máº­t kháº©u WiFi

// ================== ThingsBoard ==================
const char* tbServer = "thingsboard.cloud";
const int   tbPort   = 1883;
const char* tbToken  = "qlbr1pyum8u7bwdssrdr";   // ğŸ‘‰ Access Token

WiFiClient espClient;
PubSubClient client(espClient);

// ================== MAX30100 ==================
PulseOximeter pox;
uint32_t tsLastReport = 0;

// ================== NÃºt BOOT ==================
#define BOOT_PIN 0     // GPIO0 = nÃºt BOOT
bool tbEnabled = true; // cá» cho phÃ©p káº¿t ná»‘i ThingsBoard

// Callback khi phÃ¡t hiá»‡n nhá»‹p tim
void onBeatDetected() {
  Serial.println("â¤ï¸ Nhá»‹p tim Ä‘Æ°á»£c phÃ¡t hiá»‡n!");
}

// ================== Káº¿t ná»‘i WiFi ==================
void setup_wifi() {
  Serial.print("ğŸ”Œ Káº¿t ná»‘i WiFi: ");
  Serial.println(ssid);

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nâœ… WiFi Ä‘Ã£ káº¿t ná»‘i!");
  Serial.print("IP ESP32: ");
  Serial.println(WiFi.localIP());
}

// ================== Káº¿t ná»‘i ThingsBoard ==================
void reconnect() {
  if (!tbEnabled) return;  // náº¿u Ä‘Ã£ há»§y thÃ¬ khÃ´ng reconnect

  while (!client.connected()) {
    Serial.print("ğŸŒ Káº¿t ná»‘i ThingsBoard...");
    if (client.connect("ESP32Client", tbToken, NULL)) {
      Serial.println(" --> OK");
    } else {
      Serial.print(" --> FAIL, rc=");
      Serial.print(client.state());
      Serial.println(" thá»­ láº¡i sau 5s");
      delay(5000);
    }
  }
}

// ================== Setup ==================
void setup() {
  Serial.begin(115200);

  pinMode(BOOT_PIN, INPUT_PULLUP); // NÃºt BOOT lÃ  active LOW

  setup_wifi();
  client.setServer(tbServer, tbPort);

  Wire.begin(SDA_PIN, SCL_PIN);

  if (!pox.begin()) {
    Serial.println("âŒ KhÃ´ng tÃ¬m tháº¥y MAX30100!");
    for (;;);
  }
  Serial.println("âœ… MAX30100 sáºµn sÃ ng!");

  pox.setOnBeatDetectedCallback(onBeatDetected);
  pox.setIRLedCurrent(MAX30100_LED_CURR_20_8MA);
}

// ================== Loop ==================
void loop() {
  // Kiá»ƒm tra nÃºt BOOT
  if (digitalRead(BOOT_PIN) == LOW && tbEnabled) {
    Serial.println("ğŸ›‘ NÃºt BOOT Ä‘Æ°á»£c nháº¥n â†’ Ngáº¯t káº¿t ná»‘i ThingsBoard!");
    client.disconnect();
    tbEnabled = false;   // KhÃ´ng cho reconnect ná»¯a
    delay(1000);
  }

  // Náº¿u chÆ°a bá»‹ ngáº¯t thÃ¬ giá»¯ káº¿t ná»‘i MQTT
  if (tbEnabled) {
    if (!client.connected()) {
      reconnect();
    }
    client.loop();
  }

  // LuÃ´n cáº­p nháº­t MAX30100
  pox.update();

  // Má»—i 2s Ä‘á»c dá»¯ liá»‡u
  if (millis() - tsLastReport > 2000) {
    float bpm = pox.getHeartRate();
    float spo2 = pox.getSpO2();

    Serial.print("ğŸ’“ BPM: ");
    Serial.print(bpm);
    Serial.print(" | SpO2: ");
    Serial.println(spo2);

    // Náº¿u cÃ²n káº¿t ná»‘i TB thÃ¬ gá»­i dá»¯ liá»‡u
    if (tbEnabled && bpm > 0 && spo2 > 0) {
      String payload = "{";
      payload += "\"bpm\":";
      payload += bpm;
      payload += ",\"spo2\":";
      payload += spo2;
      payload += "}";

      client.publish("v1/devices/me/telemetry", payload.c_str());
      Serial.println("ğŸ“¤ ÄÃ£ gá»­i dá»¯ liá»‡u lÃªn ThingsBoard!");
    }

    tsLastReport = millis();
  }
}
